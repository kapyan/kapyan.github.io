<!DOCTYPE html>

<html class="theme-next pisces use-motion" lang="zh-Hans">

<head>
  <meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="baidu-site-verification" content="8zMDGR7I0p">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#222">

  <script>
    (function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2" rel="stylesheet">

  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"
                                                                                  type="text/css">

  <link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"
                                                                                  type="text/css">

  <link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png?v=5.1.4">

  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png?v=5.1.4">

  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png?v=5.1.4">

  <link rel="mask-icon" href="/images/logo.png?v=5.1.4" color="#222">

  <meta name="keywords" content="Redis主从复制和集群">

  <link rel="alternate" href="/atom.xml" title="运维之窗" type="application/atom+xml">

  <meta name="description" content="Redis主从复制 redis复制特性    使用异步复制   一个主服务器可以有多个从服务器   从服务也可以有自己的从服务器   复制功能不会阻塞主服务器   可以通过复制功能来让主服务器免于执行持久化操作，由从服务器去执行持久化操作即可            关闭主服务器持久化时，复制功能的数据安全    当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则，由于延迟等问题，部">
  <meta name="keywords" content="Redis主从复制和集群">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Redis主从复制和集群">
  <meta property="og:url" content="https://www.kapyan.top/posts/655286048.html">
  <meta property="og:site_name" content="运维之窗">
  <meta property="og:description" content="Redis主从复制 redis复制特性    使用异步复制   一个主服务器可以有多个从服务器   从服务也可以有自己的从服务器   复制功能不会阻塞主服务器   可以通过复制功能来让主服务器免于执行持久化操作，由从服务器去执行持久化操作即可            关闭主服务器持久化时，复制功能的数据安全    当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则，由于延迟等问题，部">
  <meta property="og:locale" content="zh-Hans">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/zhucong.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/redisms.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/commandpropagate.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/redisfzyzx.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sentinel.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sentinellj.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sentinelslj.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sentinels.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sentinelmss.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/sharding.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/slot.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/cluster1.svg">
  <meta property="og:image" content="https://www.kapyan.top/posts/655286048/cluster2.svg">
  <meta property="og:updated_time" content="2019-02-19T01:45:19.004Z">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Redis主从复制和集群">
  <meta name="twitter:description" content="Redis主从复制 redis复制特性    使用异步复制   一个主服务器可以有多个从服务器   从服务也可以有自己的从服务器   复制功能不会阻塞主服务器   可以通过复制功能来让主服务器免于执行持久化操作，由从服务器去执行持久化操作即可            关闭主服务器持久化时，复制功能的数据安全    当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则，由于延迟等问题，部">
  <meta name="twitter:image" content="https://www.kapyan.top/posts/655286048/zhucong.svg">

  <script type="text/javascript" id="hexo.configurations">
    var NexT = window.NexT || {};
    var CONFIG = {
      root: '/',
      scheme: 'Pisces',
      version: '5.1.4',
      sidebar: {
        "position": "left",
        "display": "post",
        "offset": 12,
        "b2t": false,
        "scrollpercent": true,
        "onmobile": true
      },
      fancybox: true,
      tabs: true,
      motion: {
        "enable": true,
        "async": false,
        "transition": {
          "post_block": "fadeIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      duoshuo: {
        userId: '0',
        author: '没有风的晴天'
      },
      algolia: {
        applicationID: '',
        apiKey: '',
        indexName: '',
        hits: {
          "per_page": 10
        },
        labels: {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      }
    };

  </script>

  <link rel="canonical" href="https://www.kapyan.top/posts/655286048.html">

  <title>Redis主从复制和集群 | 运维之窗</title>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-wrapper">
          <div class="site-meta ">

            <div class="custom-logo-site-title">
              <a href="/" class="brand" rel="start">
                <span class="logo-line-before"><i></i></span>
                <span class="site-title">运维之窗</span>
                <span class="logo-line-after"><i></i></span>
              </a>
            </div>

            <h1 class="site-subtitle" itemprop="description"></h1>

          </div>

          <div class="site-nav-toggle">
            <button>
              <span class="btn-bar"></span>
              <span class="btn-bar"></span>
              <span class="btn-bar"></span>
            </button>
          </div>
        </div>

        <nav class="site-nav">

          <ul id="menu" class="menu">

            <li class="menu-item menu-item-home">
              <a href="/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-home"></i> <br>

                首页
              </a>
            </li>

            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>

                标签
              </a>
            </li>

            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-th"></i> <br>

                分类
              </a>
            </li>

            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>

                归档
              </a>
            </li>

            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-user"></i> <br>

                关于
              </a>
            </li>

            <li class="menu-item menu-item-search">

              <a href="javascript:;" class="popup-trigger">

                <i class="menu-item-icon fa fa-search fa-fw"></i> <br>

                搜索
              </a>
            </li>

          </ul>

          <div class="site-search">

            <div class="popup search-popup local-search-popup">
              <div class="local-search-header clearfix">
                <span class="search-icon">
                  <i class="fa fa-search"></i>
                </span>
                <span class="popup-btn-close">
                  <i class="fa fa-times-circle"></i>
                </span>
                <div class="local-search-input-wrapper">
                  <input autocomplete="off" placeholder="搜索..." spellcheck="false"
                                                                                                  type="text"
                                                                                                  id="local-search-input">
                </div>
              </div>
              <div id="local-search-result"></div>
            </div>

          </div>

        </nav>

      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">

            <div id="posts" class="posts-expand">

              <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">

                <div class="post-block">
                  <link itemprop="mainEntityOfPage" href="https://www.kapyan.top/posts/655286048.html">

                  <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                    <meta itemprop="name" content="没有风的晴天">
                    <meta itemprop="description" content="">
                    <meta itemprop="image" content="/images/avatar.png">
                  </span>

                  <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
                    <meta itemprop="name" content="运维之窗">
                  </span>

                  <header class="post-header">

                    <h2 class="post-title" itemprop="name headline">Redis主从复制和集群</h2>

                    <div class="post-meta">
                      <span class="post-time">

                        <span class="post-meta-item-icon">
                          <i class="fa fa-calendar-o"></i>
                        </span>

                        <span class="post-meta-item-text">发表于</span>

                        <time title="创建于" itemprop="dateCreated datePublished"
                                                                                                        datetime="2019-02-13T16:58:21+08:00">
                          2019-02-13
                        </time>

                        <span class="post-meta-divider">|</span>

                        <span class="post-meta-item-icon">
                          <i class="fa fa-calendar-check-o"></i>
                        </span>

                        <span class="post-meta-item-text">更新于&#58;</span>

                        <time title="更新于" itemprop="dateModified" datetime="2019-02-19T09:45:19+08:00">
                          2019-02-19
                        </time>

                      </span>

                      <span class="post-category">

                        <span class="post-meta-divider">|</span>

                        <span class="post-meta-item-icon">
                          <i class="fa fa-folder-o"></i>
                        </span>

                        <span class="post-meta-item-text">分类于</span>

                        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                          <a href="/categories/redis/" itemprop="url" rel="index">
                            <span itemprop="name">redis</span>
                          </a>
                        </span>

                      </span>

                      <span class="post-comments-count">
                        <span class="post-meta-divider">|</span>
                        <span class="post-meta-item-icon">
                          <i class="fa fa-comment-o"></i>
                        </span>

                        <a href="/posts/655286048.html#SOHUCS" itemprop="discussionUrl">
                          <span id="changyan_count_unit" class="post-comments-count hc-comment-count"
                                                                                                          data-xid="posts/655286048.html"
                                                                                                          itemprop="commentsCount"></span>
                        </a>

                        <span class="post-meta-divider">|</span>
                        <span class="page-pv"><i class="fa fa-file-o"></i> 阅读数
                          <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
                        </span>

                        <div class="post-wordcount">

                          <span class="post-meta-item-icon">
                            <i class="fa fa-file-word-o"></i>
                          </span>

                          <span class="post-meta-item-text">字数统计&#58;</span>

                          <span title="字数统计">
                            5.6k
                          </span>

                          <span class="post-meta-divider">|</span>

                          <span class="post-meta-item-icon">
                            <i class="fa fa-clock-o"></i>
                          </span>

                          <span class="post-meta-item-text">阅读时长 &asymp;</span>

                          <span title="阅读时长">
                            21
                          </span>

                        </div>

                      </span></div>
                  </header>

                  <div class="post-body" itemprop="articleBody">

                    <h2 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink"
                                                                                                      title="Redis主从复制"></a>Redis主从复制</h2>
                    <h3 id="redis复制特性"><a href="#redis复制特性" class="headerlink"
                                                                                                      title="redis复制特性"></a>redis复制特性</h3>
                    <ol>
                      <li>使用异步复制</li>
                      <li>一个主服务器可以有多个从服务器</li>
                      <li>从服务也可以有自己的从服务器</li>
                      <li>复制功能不会阻塞主服务器</li>
                      <li>可以通过复制功能来让主服务器免于执行持久化操作，由从服务器去执行持久化操作即可</li>
                    </ol>
                    <p><img src="/posts/655286048/zhucong.svg" alt="主从"></p>
                    <p>
                      <center>
                        <font color="red" size="2"> 关闭主服务器持久化时，复制功能的数据安全 </font>
                      </center><br>当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则，由于延迟等问题，部署的服务应该要避免自动拉起。
                    </p>
                    <p>为了帮助理解主服务器关闭持久化时自动拉起的危险性，参考一下会导致主从服务器数据全部丢失的例子：</p>
                    <blockquote>
                      <ol>
                        <li>假设节点A为主服务器，并且关闭了持久化，并且节点B和节点C从节点A复制数据</li>
                        <li>节点A崩溃，然后由自动拉起服务重启了节点A。由于节点A的持久化被关闭了，所以重启之后没有任何数据</li>
                        <li>节点B和节点C将从节点A复制数据，但是A的数据是空的，于是就把自身保存的数据副本删除</li>
                      </ol>
                    </blockquote>
                    <p>在关闭主服务器的持久化，并同时开启自动拉起进程的情况下，即便使用Sentinel来实现Redis的高可用性，也是非常危险的。因为主服务器可能拉起得非常快，以至于Sentinel在配置的心跳时间间隔内没有检测到主服务器已被重启，然后还是会执行上面的数据丢失流程。</p>
                    <p>无论何时，数据安全都是极其重要的，所以应该禁止主服务器关闭持久化的同时自动拉起。</p>
                    <h3 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h3>
                    <p>redis主从同步有两种方式（或者说两个阶段）：全同步和部分同步。</p>
                    <p>主从刚刚连接的时候，进行全同步；全同步结束后，进行部分同步。当然，如果有需要，slave在任何时候都可以发起全同步。</p>
                    <p>redis策略是，无论如何，首先会尝试进行部分同步，如不成功，要求从机进行全同步，并启动BGSAVE，BGSAVE结束后，传输RDB文件；如果成功，允许从机进行部分同步，并传输积压空间中的数据。</p>
                    <p>下图总结了主从同步机制：<br><img src="/posts/655286048/redisms.svg"
                                                                                                      alt="ms"></p>
                    <blockquote>
                      <p><strong>主从复制过程：</strong></p>
                      <ol>
                        <li>从服务器向主服务器发送SYNC命令</li>
                        <li>接收到SYNC命令的主服务器会调用BGSAVE命令，创建一个RDB文件，并使用缓冲区记录接下来执行的所有命令</li>
                        <li>当主服务器执行完BGSAVE命令时，它会向从服务器发送RDB文件，而从服务器则会接收并载入这个文件</li>
                        <li>主服务器将缓冲区存储的所有写命令发送给从服务器执行</li>
                      </ol>
                    </blockquote>
                    <p><strong>命令的传播</strong><br>在主从服务器完成同步之后，主服务器每执行一个写命令，他都会将被执行的写命令发送给从服务器执行，这个操作被称为“命令传播”（command
                      propagate）。<br><img src="/posts/655286048/commandpropagate.svg"
                                                                                                      alt="commandpropagate"></p>
                    <p>命令传播是一个持续的过程：只要复制仍在继续，命令传播就会一直进行，使得主从服务器的状态可以一直保持一致。</p>
                    <h3 id="复制中的SYNC与PSYNC"><a href="#复制中的SYNC与PSYNC" class="headerlink"
                                                                                                      title="复制中的SYNC与PSYNC"></a>复制中的SYNC与PSYNC</h3>
                    <p>在Redis2.8版本之前，断线之后重连的从服务器总要执行一次完整重同步（full
                      resynchronization）操作。</p>
                    <p>从Redis2.8开始，Redis使用PSYNC命令代替SYNC命令。PSYNC比起SYNC的最大改进在于PSYNC实现了部分重同步（partial
                      resync）特性：在主从服务器断线并且重新连接的时候，只要条件允许，PSYNC可以让主服务器只向从服务器同步断线期间缺失的数据，而不用重新向从服务器同步整个数据库。</p>
                    <h3 id="复制的一致性问题"><a href="#复制的一致性问题" class="headerlink"
                                                                                                      title="复制的一致性问题"></a>复制的一致性问题</h3>
                    <p><img src="/posts/655286048/redisfzyzx.svg" alt="yzx"><br>在读写分离环境下，客户端向主服务器发送写命令SET
                      n 1086，主服务器在执行这个写命令之后，向客户端返回回复，并将这个写命令传播给从服务器。<br>接到回复的客户端继续向从服务器发送读命令GET
                      n，并且因为网络状态的原因，客户端的GET命令比主服务器传播的SET命令更快到达了从服务器。<br>因为从服务器键n的值还未被更新，所以客户端在从服务器读取到的将是一个错误（过期）的n值。</p>
                    <h3 id="复制安全性提升"><a href="#复制安全性提升" class="headerlink"
                                                                                                      title="复制安全性提升"></a>复制安全性提升</h3>
                    <p>主服务器只在有至少N个从服务器的情况下，才执行写操作。从Redis2.8开始，为了保证数据的安全性，可以通过配置，让主服务器只在至少有N个当前已连接从服务器的情况下，才执行写命令。<br>不过，因为Redis使用异步复制，所以主服务器发送的写数据并不一定会被从服务器接收到，因此，数据丢失的可能性仍然存在。<br>通过以下两个参数保证数据的安全：<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">min-slaves-to-write &lt;number of slaves&gt;  <span class="comment"># 从服务器个数</span></span><br><span class="line">min-slaves-max-lag &lt;number of seconds&gt;  <span class="comment"># 从服务器网络延迟（秒）</span></span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <blockquote>
                      <p>参数说明:<br>如果至少有min-slaves-to-write个从服务器，并且这些服务器的延迟值都少于min-slaves-max-lag秒，主服务器就会执行客户端的写操作。这个特性看作CAP理论中的C的条件放宽版本:
                        尽管不能保证写操的持久性，但起码丢失数据的窗口会被严格限制在指定的秒数中。<br>如果条件达不到min-slaves-to-write和min-slaves-max-lag所指定的条件，那么写操作就不会被执行，主服务器会向请求执行写操作的客户端返回一个错误。</p>
                    </blockquote>
                    <h3 id="Redis主从复制实践"><a href="#Redis主从复制实践" class="headerlink"
                                                                                                      title="Redis主从复制实践"></a>Redis主从复制实践</h3>
                    <p>启动多个Redis实例：<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-server /6380/redis.conf</span><br><span class="line">redis-server /6381/redis.conf</span><br><span class="line">redis-server /6382/redis.conf</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>配置文件示例：<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">port 6380</span><br><span class="line">pidfile /var/run/redi_6380.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">"/var/log/redis_6380.log"</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /usr/<span class="built_in">local</span>/redis/6380/</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">protected-mode no</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>复制环境说明：</p>
                    <ul>
                      <li>主节点：6380</li>
                      <li>从节点：6381、6382</li>
                    </ul>
                    <p>开启主从（在6381、6382实例中执行）<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-cli -p 6381/6382</span><br><span class="line">SLAVEOF 127.0.0.1 6380</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <h3 id="Redis主从复制管理"><a href="#Redis主从复制管理" class="headerlink"
                                                                                                      title="Redis主从复制管理"></a>Redis主从复制管理</h3>
                    <p>主从复制状态监控：<code>info replication</code><br>主从切换：<code>slaveof
                        no one</code>(在从库执行，将从库设为主库)</p>
                    <h2 id="Redis-HA实践（Redis-Sentinel）"><a href="#Redis-HA实践（Redis-Sentinel）"
                                                                                                      class="headerlink"
                                                                                                      title="Redis HA实践（Redis Sentinel）"></a>Redis
                      HA实践（Redis Sentinel）</h2>
                    <p>Redis-Sentinel是Redis官方推荐的高可用性（HA）解决方案，当用Redis做Master-salve的高可用方案时，假如master宕机了，Redis本身（包括它的很多客户端）都没有实现自动进行主备切换，而Redis-sentinel本身也是一个独立运行的进程，它能监控多个master-slave集群，发现master宕机后能进行自动切换。</p>
                    <p><img src="/posts/655286048/sentinel.svg" alt="yzx"><br>Sentinel是一个监视器，它可以根据被监视实例的身份和状态来判断应该执行何种动作。</p>
                    <h3 id="Redis-Sentinel功能"><a href="#Redis-Sentinel功能" class="headerlink"
                                                                                                      title="Redis Sentinel功能"></a>Redis
                      Sentinel功能</h3>
                    <p><strong>监控（Monitoring）：</strong><br>Sentinel会不断地检查主服务器和从服务器是否运作正常。<br><strong>提醒（Notification）：</strong><br>当被监控的某个Redis服务器出现问题时，Sentinel可以通过API向管理员或其他应用程序发送通知。<br><strong>自动故障迁移（Automatic
                        failover）：</strong><br>当一个主服务器不能正常工作时，Sentinel会开始一次自动故障迁移操作，它会将失效主服务器的其中一个从服务器升级为新的主服务器，并让失效主服务器的其他从服务器改为复制新的主服务器；当客户端试图连接失效的主服务器时，集群也会向客户端返回新主服务器的地址，使得集群可以使用新主服务器代替失效服务器。</p>
                    <h3 id="服务器连接"><a href="#服务器连接" class="headerlink" title="服务器连接"></a>服务器连接</h3>
                    <p>发现并连接主服务器:<br>Sentinel通过用户给定的配置文件来发现主服务器。</p>
                    <p><img src="/posts/655286048/sentinellj.svg" alt="lj"></p>
                    <p>Sentinel会与被监视的主服务器创建两个网络连接：</p>
                    <ol>
                      <li>命令连接：用于向主服务器发送命令。</li>
                      <li>订阅连接：用于订阅指定的频道，从而发现监视同一主服务器的其他Sentinel。</li>
                    </ol>
                    <p>发现并连接从服务器：<br>Sentinel通过向主服务器发送INFO命令来自动获得所有从服务器的地址。<br>跟主服务器一样，Sentinel会与每个被发现的从服务器创建命令连接和订阅连接。</p>
                    <p><img src="/posts/655286048/sentinelslj.svg" alt="slj"></p>
                    <p>发现其他Sentinel：<br>Sentinel会通过命令连接向被监视的主从服务器发送“HELLO”信息，该消息包含Sentinel的IP、端口、ID等内容，以此来向其他Sentinel宣告自己的存在。与此同时Sentinel会通过订阅连接接收其他Sentinel的“HELLO”信息，以此来发现监视同一个主服务器的其他Sentinel。</p>
                    <p><img src="/posts/655286048/sentinels.svg" alt="sls"></p>
                    <p>sentinel1通过发送HELLO信息来让sentinel2和sentinel3发现自己，其他两个sentinel也会进行类似的操作。</p>
                    <p>多个Sentinel之间的连接：<br>Sentinel之间只会互相创建命令连接，用于通信。因为已经有主从服务器作为发送和接收HELLO信息的中介，所以Sentinel之间不会创建订阅连接。</p>
                    <p><img src="/posts/655286048/sentinelmss.svg" alt="mss"></p>
                    <blockquote>
                      <p>Redis的Sentinel中关于下线（down）有两个不同的概念：<br>主观下线（Subjectively
                        Down，简称SDOWN）指的是单个Sentinel实例对服务器做出的下线判断。<br>客观下线（Objectively
                        Down，简称ODOWN）指的是多个Sentinel实例在对同一个服务器做出SDOWN判断，并且通过SENTINEL
                        is-master-down
                        -by-addr命令互相交流之后，得出的服务器下线判断。（一个Sentinel可以通过向另一个Sentinel发送SENTINEL
                        is-master-down-by-addr命令来询问对方是否认为给定的服务器已下线。）</p>
                    </blockquote>
                    <p>如果一个服务器没有在master-down-after-milliseconds选项所指定的时间内，对向它发送PING命令的Sentinel返回一个有效回复（valid
                      reply），那么Sentinel就会将这个服务器标记为主观下线。</p>
                    <h3 id="故障转移FAILOVER"><a href="#故障转移FAILOVER" class="headerlink"
                                                                                                      title="故障转移FAILOVER"></a>故障转移FAILOVER</h3>
                    <p>一次故障转移操作由以下步骤组成：</p>
                    <ol>
                      <li>发现主服务器已进入客观下线状态；</li>
                      <li>基于Raft leader election协议，进行投票选举；</li>
                      <li>如果当选失败，那么在设定的故障迁移超时时间的两倍之后，重新尝试当选。如果当选成功，那么执行以下步骤；</li>
                      <li>选出一个从服务器，并将它升级为主服务器；</li>
                      <li>向被选中的从服务器发送SLAVEOF NO ONE命令，让它转变为主服务器；</li>
                      <li>通过发布与订阅功能，将更新后的配置传播给所有其他Sentinel，其他Sentinel对他们自己的配置进行更新；</li>
                      <li>向已下线主服务器的从服务器发送SLAVEOF命令，让它们去复制新的主服务器；</li>
                      <li>当所有从服务器都已经开始复制新的主服务器时，leader Sentinel终止这次故障迁移操作。</li>
                    </ol>
                    <h3 id="配置sentinel"><a href="#配置sentinel" class="headerlink"
                                                                                                      title="配置sentinel"></a>配置sentinel</h3>
                    <p>创建程序目录<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="built_in">cd</span> /application</span><br><span class="line">mkdir 26380</span><br><span class="line">cp /usr/<span class="built_in">local</span>/redis/src/redis-sentinel ./26380/</span><br><span class="line"><span class="built_in">cd</span> 26380</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>编辑配置文件<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">vim sentinel.conf</span><br><span class="line"><span class="comment"># 写入以下配置</span></span><br><span class="line">port 26380</span><br><span class="line">dir <span class="string">"/tmp"</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6370 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line">sentinel config-epoch mymaster 0</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>启动sentinel<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">./redis-sentinel ./sentinel.conf</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>配置文件说明：<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="comment"># 指定监控master</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6370 2</span><br><span class="line"><span class="comment"># 2表示多少个sentinel同意</span></span><br><span class="line"><span class="comment"># 安全信息</span></span><br><span class="line">sentinel auth-pass mymaster root</span><br><span class="line"><span class="comment"># 超过15000毫秒后认为主机宕机</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 15000</span><br><span class="line"><span class="comment"># 当主从切换多久后认为主从切换失败</span></span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="comment"># 这两个配置后面的数量主从机需要一样，epoch为master的版本</span></span><br><span class="line">sentinel leader-epoch mymaster 1</span><br><span class="line">sentinel config-epoch mymaster 1</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <h4 id="Sentinel命令操作"><a href="#Sentinel命令操作" class="headerlink"
                                                                                                      title="Sentinel命令操作"></a>Sentinel命令操作</h4>
                    <table>
                      <thead>
                        <tr>
                          <th>命令</th>
                          <th>描述</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>PING</td>
                          <td>返回PONG</td>
                        </tr>
                        <tr>
                          <td>SENTINEL masters</td>
                          <td>列出所有被监视的主服务器</td>
                        </tr>
                        <tr>
                          <td>SENTINEL slaves <master name=""></master>
                          </td>
                          <td>列出指定master的所有slave及它们的状态</td>
                        </tr>
                        <tr>
                          <td>SENTINEL get-master-addr-by-name <master name=""></master>
                          </td>
                          <td>返回给定名字的服务器的IP地址和端口号</td>
                        </tr>
                        <tr>
                          <td>SENTINEL reset <pattern></pattern>
                          </td>
                          <td>重置所有名字和给定模式pattern相匹配的主服务器</td>
                        </tr>
                        <tr>
                          <td>SENTINEL failover <master name=""></master>
                          </td>
                          <td>当主服务器失效时，在不询问其他Sentinel意见的情况下，强制开始一次自动故障迁移</td>
                        </tr>
                      </tbody>
                    </table>
                    <h3 id="Sentinel发布与订阅信息"><a href="#Sentinel发布与订阅信息" class="headerlink"
                                                                                                      title="Sentinel发布与订阅信息"></a>Sentinel发布与订阅信息</h3>
                    <p>客户端可以将Sentinel看作是一个只提供了订阅功能的Redis服务器：不可以使用PUBLISH命令向这个服务器发送信息，但可以用SUBSCRIBE命令或PSUBSCRIBE命令，通过订阅给定的频道来获取相应的事件提醒。<br>一个频道能够接受和这个频道的名字相同的事件。比如：名为
                      + sdown的频道就可以接受所有实例进入主观下线（SDOWN）状态的事件。<br>通过执行PSUBSCRIBE
                      * 命令可以接收所有事件信息。<br>以下列出的是客户端可以通过订阅来获得的频道和信息的格式：<br><code>第一个英文单词是频道
                        / 事件的名字，其余的是数据的格式</code></p>
                    <blockquote>
                      <p>注意：<br>当格式中包含instance
                        details字样时，表示频道所返回的信息中包含了以下用于识别目标实例的内容：<br>
                        <figure class="highlight plain">
                          <table>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line">&lt;instance-type&gt;&lt;name&gt;&lt;ip&gt;&lt;port&gt;@&lt;master-name&gt;&lt;master-ip&gt;&lt;master-port &gt;</span><br><span class="line">@字符之后的内容用于指定主服务器，这些内容是可选的，它们仅在@字符之前的内容指定的实例不是主服务器时使用。</span><br></pre>
                              </td>
                            </tr>
                          </table>
                        </figure>
                      </p>
                    </blockquote>
                    <h2 id="Redis-cluster-集群"><a href="#Redis-cluster-集群" class="headerlink"
                                                                                                      title="Redis cluster(集群)"></a>Redis
                      cluster(集群)</h2>
                    <h3 id="Redis集群"><a href="#Redis集群" class="headerlink"
                                                                                                      title="Redis集群"></a>Redis集群</h3>
                    <p>Redis集群是一个可以在多个Redis节点之间进行数据共享的设施（installation）。<br>Redis集群不支持那些需要同时处理多个键的Redis命令，因为执行这些命令需要在多个Redis节点之间移动数据，并且在高负载的情况下，这些命令将降低Redis集群的性能，并导致不可预测的行为。<br>Redis集群通过分区（partition）来提供一定程度的可用性（availability）：即使集群中一部分节点失效或者无法进行通讯，集群也可以继续处理命令请求。将数据自动切分（split）到多个节点的能力。<br>当集群中的一部分节点失效或者无法进行通讯时，仍然可以继续处理命令请求的能力。</p>
                    <h3 id="Redis集群数据共享"><a href="#Redis集群数据共享" class="headerlink"
                                                                                                      title="Redis集群数据共享"></a>Redis集群数据共享</h3>
                    <p>Redis集群使用数据分片（sharding）而非一致性哈希（consistency
                      hashing）来实现：一个Redis集群包含16384个哈希槽（hash
                      slot），数据库中的每个键都属于这16384个哈希槽的其中一个，集群使用公式CRC16（key）%
                      16384来计算键key属于哪个槽，其中CRC16（key）语句用于计算键key的CRC校验和。</p>
                    <blockquote>
                      <p>节点A负责处理0号至5500号哈希槽<br>节点B负责处理5501号至11000号哈希槽<br>节点C负责处理11001号至16384号哈希槽</p>
                    </blockquote>
                    <p>槽的计算公式： CRC16(key) % 16383</p>
                    <p><img src="/posts/655286048/sharding.svg" alt="sharding"></p>
                    <h3 id="集群运行机制"><a href="#集群运行机制" class="headerlink" title="集群运行机制"></a>集群运行机制</h3>
                    <p>所有的redis节点彼此互联（PING-PONG机制），内部使用二进制协议优化传输速度和带宽。<br>节点的fail是通过集群中超过半数的master节点检测失效时才失效。<br>客户端与redis节点直连，不需要中间proxy层。客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可。<br>把所有的物理节点映射到[0-16383]slot上，cluster负责维护node<->slot<->key</->
                      </->
                    </p>
                    <p><img src="/posts/655286048/slot.svg" alt="sharding"></p>
                    <p>为了使得集群在一部分节点下线或者无法与集群的大多数（majority）节点进行通讯的情况下，仍然可以正常运作，Redis集群对节点使用了主从复制功能：集群中的每个节点都有1个至N个复制品（replication），其中一个复制品为主节点（master），而其余的N
                      - 1个复制品为从节点（slave）。</p>
                    <blockquote>
                      <p>在之前列举的节点A、B、C的例子中，如果节点B下线了，那么集群将无法正常运行，因为集群找不到节点来处理5501号至11000号的哈希槽。<br>假如在创建集群的时候（或者至少在节点B下线之前），我们为主节点B添加了从节点B1，那么当主节点B下线的时候，集群就会将B1设置为新的主节点，并让它代替下线的主节点B,
                        继续处理5501号至11000号的哈希槽，这样集群就不会因为主节点B的下线而无法正常运作了。<br>不过，如果节点B和B1都下线的话，Redis集群还是会停止工作。</p>
                    </blockquote>
                    <p>集群的复制特性重用了SLAVEOF命令代码，所以集群节点的复制行为和SLAVEOF命令的复制行为完全相同。</p>
                    <h3 id="集群的故障转移"><a href="#集群的故障转移" class="headerlink"
                                                                                                      title="集群的故障转移"></a>集群的故障转移</h3>
                    <ol>
                      <li>在集群里面，节点会对其他节点进行下线检测。</li>
                      <li>当一个主节点下线时，集群里面的其它主节点会负责对下线主节点进行故障转移。</li>
                      <li>换句话说，集群的节点集成了下线检测和故障转移等类似Sentinel的功能。</li>
                      <li>因为Sentinel是一个独立运行的监控程序，而集群的下线检测和故障转移等功能是集成在节点里面的，它们的运行模式非常地不同，所以尽管这两者功能很相似，但集群的实现没有重用Sentinel的代码。</li>
                    </ol>
                    <p>在集群里执行命令的两种情况：</p>
                    <ol>
                      <li>命令发送到了正确的节点：<br>命令要处理的键所在的槽正好是由接收命令的节点负责，那么该节点执行命令，就像单机Redis服务器一样。</li>
                    </ol>
                    <p><img src="/posts/655286048/cluster1.svg" alt="cluster1"></p>
                    <blockquote>
                      <p>槽位说明：<br>7000：槽0~5000 7001：槽5001~10000
                        7002：槽10001~16383<br>键date位于2022槽，该槽由节点7000负责，命令会直接执行。</p>
                    </blockquote>
                    <ol start="2">
                      <li>命令发送到了错误的节点：<br>接收到命令的节点并非处理键所在槽的节点，那么节点将向客户端返回一个转向（redirection）错误，告知客户端应该到哪个节点去执行这个命令，客户端会根据错误提示的信息，重新向正确的节点发送命令。</li>
                    </ol>
                    <p><img src="/posts/655286048/cluster2.svg" alt="cluster2"></p>
                    <blockquote>
                      <p>键date位于2022槽，该槽点由7000负责，但错误发送到了7001节点，7001向客户返回转向错误。<br>客户端根据转向错误的指引，转向到节点7000，并重新发送命令。</p>
                    </blockquote>
                    <h3 id="关于转向错误"><a href="#关于转向错误" class="headerlink" title="关于转向错误"></a>关于转向错误</h3>
                    <p>在集群中的节点会互相告知对方，自己负责处理哪些槽点。集群中的每个节点都会记录16384个槽分别由哪个节点负责，从而形成一个“槽表”（slot
                      table）。<br>节点在接收到命令请求时，会通过槽表检查键所在的槽是否由本节点处理：</p>
                    <ul>
                      <li>如果是，那么节点直接执行命令</li>
                      <li>如果不是，那么节点就从槽表里面提取出正确节点的地址信息，然后返回转向错误。</li>
                    </ul>
                    <h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h3>
                    <figure class="highlight bash">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">yum install centos-release-scl-rh　　  <span class="comment"># 会在/etc/yum.repos.d/目录下多出一个CentOS-SCLo-scl-rh.repo源</span></span><br><span class="line">yum install rh-ruby23 -y</span><br><span class="line">scl <span class="built_in">enable</span> rh-ruby23 bash  <span class="comment"># 必须执行</span></span><br><span class="line">ruby -v  <span class="comment"># 查看ruby版本</span></span><br><span class="line">gem install redis-v4.1.0  <span class="comment"># redis-trib 工具执行需要安装redis gem才能执行</span></span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>
                    <p>配置文件<br>Redis集群由多个运行在集群模式（cluster
                      mode）下的Redis实例组成，实例的集群模式需要通过配置来开启，开启集群模式的实例将可以使用集群特有的功能和命令。<br>以下是一个包含了最少选项的集群配置文件示例：<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">port 7000</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>创建程序目录<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="built_in">cd</span> /application/redis</span><br><span class="line">mkdir 7000 7001 7002 7003 7004 7005</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>拷贝应用<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 0 1 2 3 4 5</span><br><span class="line"><span class="keyword">do</span> cp /usr/<span class="built_in">local</span>/redis/bin/redis-server  ./700<span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>创建配置文件<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 7000 7001 7002 7003 7004 7005</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"port <span class="variable">$i</span></span></span><br><span class="line"><span class="string">cluster-enabled yes</span></span><br><span class="line"><span class="string">cluster-config-file nodes.conf</span></span><br><span class="line"><span class="string">cluster-node-timeout 5000</span></span><br><span class="line"><span class="string">appendonly yes</span></span><br><span class="line"><span class="string">daemonize yes"</span>&gt;<span class="variable">$i</span>/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>启动redis集群<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 7000 7001 7002 7003 7004 7005</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$i</span></span><br><span class="line">    ./redis-server ./redis.conf &amp;</span><br><span class="line">    <span class="built_in">cd</span> ../</span><br><span class="line"><span class="keyword">done</span></span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>创建集群<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis/src/</span><br><span class="line">. /redis-trib.rb  create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <blockquote>
                      <p>给定redis-trib.rb程序的命令是create，表示创建一个新的集群。<br>选项–replicas
                        1
                        表示集群中的每个主节点创建一个从节点。</p>
                    </blockquote>
                    <h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3>
                    <p>写数据，查看集群状态<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-cli -c -p 7000	<span class="comment">#-c连接集群结点时使用，此选项可防止moved和ask异常</span></span><br><span class="line"><span class="built_in">set</span> foo bar</span><br><span class="line">get foo</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>重新分片实践<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis/src/</span><br><span class="line">./redis-trib.rb reshard 127.0.0.1:7000</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>集群状态<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-cli -p 7000 cluster nodes | grep master</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>故障转移<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-cli -p 7002 debug segfault</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>查看状态<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-cli -p 7000 cluster info | grep master</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>增加新的节点<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">./redis-trib.rb add-node 127.0.0.1:7006 127.0.0.1:7000</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>删除一个节点<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">redis-trib del-node ip:port <span class="string">'&lt;node-id&gt;'</span></span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p>删除master节点之前首先使用reshard移除master的全部slot，然后再删除当前节点<br>添加一个从节点<br>
                      <figure class="highlight bash">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line">./redis-trib.rb add-node--slave --master-id $[nodeid] 127.0.0.1:7008 127.0.0.1:7000</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <h3 id="状态说明"><a href="#状态说明" class="headerlink" title="状态说明"></a>状态说明</h3>
                    <figure class="highlight bash">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">[root@localhost ~]<span class="comment">#redis-cli -p 7000 cluster nodes | grep master</span></span><br><span class="line">35b7fac5750c997412dc6826802bfb78d5b81abf 127.0.0.1: 7001@17001 master - 0 1548925480000 2 connected 5461 - 10922</span><br><span class="line">3c3106bd8740706bebe2341e90d08554ab2bcd52 127.0.0.1: 7000@17000 myself, master - 0 1548925480000 1 connected 0 - 5460</span><br><span class="line">e190049acbd61ecb16e82cca3d6aa06dd0927305 127.0.0.1: 7002@17002 master - 0 1548925481046 3 connected 10923 - 16383</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>
                    <p>集群最近一次向节点发送PING命令之后，过去了多长时间还没接到回复。<br>节点最近一次返回PONG回复的时间。<br>节点的配置节点（configuration
                      epoch）。<br>本节点的网络连接情况：例如connected。<br>节点目前包含的槽：例如127.0.0.1:
                      7001目前包含号码为 5461
                      - 10922的哈希槽。</p>
                    <h3 id="使用redis-py-cluster模块操作redis集群"><a href="#使用redis-py-cluster模块操作redis集群"
                                                                                                      class="headerlink"
                                                                                                      title="使用redis-py-cluster模块操作redis集群"></a>使用redis-py-cluster模块操作redis集群</h3>
                    <figure class="highlight bash">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">pip install --default-timeout=100 redis-py-cluster  <span class="comment">#安装redis-py-cluster扩展</span></span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>
                    <p>python连接redis代码：<br>
                      <figure class="highlight python">
                        <table>
                          <tr>
                            <td class="gutter">
                              <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                            </td>
                            <td class="code">
                              <pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> rediscluster <span class="keyword">import</span> StrictRedisCluster</span><br><span class="line"></span><br><span class="line">redis_nodes = [&#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7000</span>&#125;,</span><br><span class="line">               &#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7001</span>&#125;,</span><br><span class="line">               &#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7002</span>&#125;,</span><br><span class="line">               &#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7003</span>&#125;,</span><br><span class="line">               &#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7004</span>&#125;,</span><br><span class="line">               &#123;<span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>, <span class="string">'port'</span>: <span class="number">7005</span>&#125;</span><br><span class="line">               ]</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    redisconn = StrictRedisCluster(startup_nodes=redis_nodes)</span><br><span class="line">    redisconn.set(<span class="string">'name'</span>, <span class="string">'admin'</span>)</span><br><span class="line">    print(<span class="string">"name is: "</span>, redisconn.get(<span class="string">'name'</span>))</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    print(<span class="string">"Connect Error!"</span>)</span><br></pre>
                            </td>
                          </tr>
                        </table>
                      </figure>
                    </p>
                    <p><a href="https://redis-py-cluster.readthedocs.io/en/master/index.html">redis-py-cluster官方文当</a></p>

                  </div>

                  <div style="text-align:center;color: #ccc;font-size:14px;">----------------
                    (*￣︶￣)我是结束线(*￣︶￣) ----------------</div>

                  <div>
                    <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
                      <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.jpg"
                                                                                                      alt="没有风的晴天 wechat"
                                                                                                      style="width: 200px; max-width: 100%;">
                      <div>扫一扫，加我微信</div>
                    </div>

                  </div>

                  <div>
                    <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                      <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
                      <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                        <span>打赏</span>
                      </button>
                      <div id="QR" style="display: none;">

                        <div id="wechat" style="display: inline-block">
                          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="没有风的晴天 微信支付">
                          <p>微信支付</p>
                        </div>

                        <div id="alipay" style="display: inline-block">
                          <img id="alipay_qr" src="/images/alipay.jpg" alt="没有风的晴天 支付宝">
                          <p>支付宝</p>
                        </div>

                      </div>
                    </div>

                  </div>

                  <div>
                    <ul class="post-copyright">
                      <li class="post-copyright-author">
                        <strong>本文作者：</strong>
                        没有风的晴天
                      </li>
                      <li class="post-copyright-link">
                        <strong>本文链接：</strong>
                        <a href="https://www.kapyan.top/posts/655286048.html"
                                                                                                        title="Redis主从复制和集群">https://www.kapyan.top/posts/655286048.html</a>
                      </li>
                      <li class="post-copyright-license">
                        <strong>版权声明： </strong>
                        本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"
                                                                                                        rel="external nofollow"
                                                                                                        target="_blank">CC
                          BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
                      </li>
                    </ul>

                  </div>

                  <footer class="post-footer">

                    <div class="post-tags">

                      <a href="/tags/Redis集群/" rel="tag"><i class="fa fa-tag"></i>
                        Redis集群</a>

                    </div>

                    <div class="post-series">
                      <h4>redis-相关文章：</h4>

                      <li><a href="/posts/424997909.html"> 关于Redis的一些了解 </a></li>

                      <li><a href="/posts/2273748276.html"> Redis管理 </a></li>

                    </div>

                    <div class="post-widgets">

                      <div id="needsharebutton-postbottom">
                        <span class="btn">
                          <i class="fa fa-share-alt" aria-hidden="true"></i>
                        </span>
                      </div>

                    </div>

                    <div class="post-nav">
                      <div class="post-nav-next post-nav-item">

                        <a href="/posts/3397780315.html" rel="next" title="echo 0 > /proc/sys/kernel/hung_task_timeout_secs disables this message故障处理">
                          <i class="fa fa-chevron-left"></i> echo 0 >
                          /proc/sys/kernel/hung_task_timeout_secs disables this
                          message故障处理
                        </a>

                      </div>

                      <span class="post-nav-divider"></span>

                      <div class="post-nav-prev post-nav-item">

                      </div>
                    </div>

                  </footer>
                </div>

              </article>

              <div class="post-spread">

              </div>
            </div>

          </div>

          <div class="comments" id="comments">
            <div id="SOHUCS"></div>
          </div>

        </div>

        <div class="sidebar-toggle">
          <div class="sidebar-toggle-line-wrap">
            <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
            <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
            <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
          </div>
        </div>

        <aside id="sidebar" class="sidebar">

          <div id="sidebar-dimmer"></div>

          <div class="sidebar-inner">

            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
                文章目录
              </li>
              <li class="sidebar-nav-overview" data-target="site-overview-wrap">
                站点概览
              </li>
            </ul>

            <section class="site-overview-wrap sidebar-panel">
              <div class="site-overview">
                <div class="site-author motion-element" itemprop="author"
                                                                                                itemscope=""
                                                                                                itemtype="http://schema.org/Person">

                  <img class="site-author-image" itemprop="image" src="/images/avatar.png"
                                                                                                  alt="没有风的晴天">

                  <p class="site-author-name" itemprop="name">没有风的晴天</p>
                  <p class="site-description motion-element" itemprop="description"></p>
                </div>

                <nav class="site-state motion-element">

                  <div class="site-state-item site-state-posts">

                    <a href="/archives/">

                      <span class="site-state-item-count">13</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>

                  <div class="site-state-item site-state-categories">
                    <a href="/categories/index.html">
                      <span class="site-state-item-count">7</span>
                      <span class="site-state-item-name">分类</span>
                    </a>
                  </div>

                  <div class="site-state-item site-state-tags">
                    <a href="/tags/index.html">
                      <span class="site-state-item-count">12</span>
                      <span class="site-state-item-name">标签</span>
                    </a>
                  </div>

                </nav>

                <div class="feed-link motion-element">
                  <a href="/atom.xml" rel="alternate">
                    <i class="fa fa-rss"></i>
                    RSS
                  </a>
                </div>

                <div class="links-of-author motion-element">

                  <span class="links-of-author-item">
                    <a href="https://github.com/kapyan" target="_blank" title="GitHub">

                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>

                  <span class="links-of-author-item">
                    <a href="mailto:15929461370@163.com" target="_blank" title="E-Mail">

                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>

                </div>

                <div class="links-of-blogroll motion-element links-of-blogroll-inline">
                  <div class="links-of-blogroll-title">
                    <i class="fa  fa-fw fa-link"></i>
                    友情链接
                  </div>
                  <ul class="links-of-blogroll-list">

                    <li class="links-of-blogroll-item">
                      <a href="http://music.kapyan.top" title="在线音乐" target="_blank"
                                                                                                      rel="external nofollow">在线音乐</a>
                    </li>

                    <li class="links-of-blogroll-item">
                      <a href="http://video.kapyan.top" title="小熊影院" target="_blank"
                                                                                                      rel="external nofollow">小熊影院</a>
                    </li>

                  </ul>
                </div>

                <!-- CloudCalendar -->
                <div class="widget-wrap" style="width: 90%;margin-left: auto;margin-right: auto; opacity: 0.97;">
                  <div class="widget" id="CloudCalendar"></div>
                </div>

              </div>
            </section>

            <!--noindex-->
            <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
              <div class="post-toc">

                <div class="post-toc-content">
                  <ol class="nav">
                    <li class="nav-item nav-level-2"><a class="nav-link" href="#Redis主从复制"><span
                                                                                                        class="nav-number">1.</span>
                        <span class="nav-text">Redis主从复制</span></a>
                      <ol class="nav-child">
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#redis复制特性"><span
                                                                                                            class="nav-number">1.1.</span>
                            <span class="nav-text">redis复制特性</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#主从复制原理"><span
                                                                                                            class="nav-number">1.2.</span>
                            <span class="nav-text">主从复制原理</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#复制中的SYNC与PSYNC"><span
                                                                                                            class="nav-number">1.3.</span>
                            <span class="nav-text">复制中的SYNC与PSYNC</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#复制的一致性问题"><span
                                                                                                            class="nav-number">1.4.</span>
                            <span class="nav-text">复制的一致性问题</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#复制安全性提升"><span
                                                                                                            class="nav-number">1.5.</span>
                            <span class="nav-text">复制安全性提升</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Redis主从复制实践"><span
                                                                                                            class="nav-number">1.6.</span>
                            <span class="nav-text">Redis主从复制实践</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Redis主从复制管理"><span
                                                                                                            class="nav-number">1.7.</span>
                            <span class="nav-text">Redis主从复制管理</span></a></li>
                      </ol>
                    </li>
                    <li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-HA实践（Redis-Sentinel）"><span
                                                                                                        class="nav-number">2.</span>
                        <span class="nav-text">Redis
                          HA实践（Redis Sentinel）</span></a>
                      <ol class="nav-child">
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Redis-Sentinel功能"><span
                                                                                                            class="nav-number">2.1.</span>
                            <span class="nav-text">Redis
                              Sentinel功能</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#服务器连接"><span
                                                                                                            class="nav-number">2.2.</span>
                            <span class="nav-text">服务器连接</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#故障转移FAILOVER"><span
                                                                                                            class="nav-number">2.3.</span>
                            <span class="nav-text">故障转移FAILOVER</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#配置sentinel"><span
                                                                                                            class="nav-number">2.4.</span>
                            <span class="nav-text">配置sentinel</span></a>
                          <ol class="nav-child">
                            <li class="nav-item nav-level-4"><a class="nav-link"
                                                                                                              href="#Sentinel命令操作"><span
                                                                                                                class="nav-number">2.4.1.</span>
                                <span class="nav-text">Sentinel命令操作</span></a></li>
                          </ol>
                        </li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Sentinel发布与订阅信息"><span
                                                                                                            class="nav-number">2.5.</span>
                            <span class="nav-text">Sentinel发布与订阅信息</span></a></li>
                      </ol>
                    </li>
                    <li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-cluster-集群"><span
                                                                                                        class="nav-number">3.</span>
                        <span class="nav-text">Redis
                          cluster(集群)</span></a>
                      <ol class="nav-child">
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Redis集群"><span
                                                                                                            class="nav-number">3.1.</span>
                            <span class="nav-text">Redis集群</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#Redis集群数据共享"><span
                                                                                                            class="nav-number">3.2.</span>
                            <span class="nav-text">Redis集群数据共享</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#集群运行机制"><span
                                                                                                            class="nav-number">3.3.</span>
                            <span class="nav-text">集群运行机制</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#集群的故障转移"><span
                                                                                                            class="nav-number">3.4.</span>
                            <span class="nav-text">集群的故障转移</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#关于转向错误"><span
                                                                                                            class="nav-number">3.5.</span>
                            <span class="nav-text">关于转向错误</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#配置集群"><span
                                                                                                            class="nav-number">3.6.</span>
                            <span class="nav-text">配置集群</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#集群管理"><span
                                                                                                            class="nav-number">3.7.</span>
                            <span class="nav-text">集群管理</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#状态说明"><span
                                                                                                            class="nav-number">3.8.</span>
                            <span class="nav-text">状态说明</span></a></li>
                        <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                          href="#使用redis-py-cluster模块操作redis集群"><span
                                                                                                            class="nav-number">3.9.</span>
                            <span class="nav-text">使用redis-py-cluster模块操作redis集群</span></a></li>
                      </ol>
                    </li>
                  </ol>
                </div>

              </div>
            </section>
            <!--/noindex-->

          </div>
        </aside>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
          <span class="with-love">
            <i class="fa fa-user"></i>
          </span>
          <span class="author" itemprop="copyrightHolder">没有风的晴天</span>

          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-area-chart"></i>
          </span>

          <span class="post-meta-item-text">Site words total count&#58;</span>

          <span title="Site words total count">25.8k</span>

        </div>

        <div class="footer-custom">
          <div class="BbeiAn-info">陕ICP备-<a target="_blank" href="http://www.miitbeian.gov.cn/">17003351号-1</a></div>
        </div>

        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize("");
          }

        </script>

        <div class="busuanzi-count">
          <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

          <span class="site-uv">
            <i class="fa fa-user"></i> 访问人数
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>

          </span>

          <span class="site-pv">
            <i class="fa fa-eye"></i> 总访问量
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>

          </span>

        </div>

      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>

      <span id="scrollpercent"><span>0</span>%</span>

    </div>

  </div>

  <script type="text/javascript">
    if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
      window.Promise = null;
    }

  </script>

  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>

  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>

  <script type="text/javascript">
    (function() {
      var appid = 'cyu5jPBKt';
      var conf = 'c5ce34b4cfb52fb37a87120bf5d492e1';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
        window.document.write(
          '<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' +
          appid + '&conf=' + conf + '"><\/script>');
      } else {
        var loadJs = function(d, a) {
          var c = document.getElementsByTagName("head")[0] || document.head ||
            document.documentElement;
          var b = document.createElement("script");
          b.setAttribute("type", "text/javascript");
          b.setAttribute("charset", "UTF-8");
          b.setAttribute("src", d);
          if (typeof a === "function") {
            if (window.attachEvent) {
              b.onreadystatechange = function() {
                var e = b.readyState;
                if (e === "loaded" || e === "complete") {
                  b.onreadystatechange = null;
                  a()
                }
              }
            } else {
              b.onload = a
            }
          }
          c.appendChild(b)
        };
        loadJs("https://changyan.sohu.com/upload/changyan.js", function() {
          window.changyan.api.config({
            appid: appid,
            conf: conf
          })
        });
      }
    })();

  </script>
  <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;
    var onPopupClose = function(e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append(
          '<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css(
        'text-align', 'center');
      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(
                  /<[^>]+>/g, "");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if (title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text,
                      caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0,
                        position = [],
                        index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word,
                          startPosition)) > -1) {
                        index.push({
                          position: position,
                          word: word
                        });
                        startPosition = position + wordLen;
                      }
                      return index;
                    }
                    indexOfTitle = indexOfTitle.concat(
                      getIndexByWord(keyword,
                        titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(
                      getIndexByWord(keyword,
                        contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length >
                    0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length +
                      indexOfContent.length;
                  }
                }
                // show search results
                if (isMatch) {
                  // sort index by position of keyword
                  [indexOfTitle, indexOfContent].forEach(function(
                    index) {
                    index.sort(function(itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft
                        .position) {
                        return itemRight.position -
                          itemLeft.position;
                      } else {
                        return itemLeft.word.length -
                          itemRight.word.length;
                      }
                    });
                  });
                  // merge hits into slices
                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index
                      .length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({
                        position: position,
                        length: word.length
                      });
                      var wordEnd = position + word.length;
                      // move to next position of hit
                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }
                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0,
                      title.length, indexOfTitle));
                  }
                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length -
                      1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if (start < 0) {
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if (end > content.length) {
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content,
                      start, end, indexOfContent));
                  }
                  // sort slices in content by search text's count and hits' count
                  slicesOfContent.sort(function(sliceLeft,
                    sliceRight) {
                    if (sliceLeft.searchTextCount !==
                      sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount -
                        sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !==
                      sliceRight.hits.length) {
                      return sliceRight.hits.length -
                        sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });
                  // select top N slices in content
                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0,
                      upperBound);
                  }
                  // highlight title and content
                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function(hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' +
                        text.substring(hit.position, end) +
                        '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }
                  var resultItem = '';
                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl +
                      "' class='search-result-title'>" +
                      highlightKeyword(title, slicesOfTitle[0]) +
                      "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl +
                      "' class='search-result-title'>" + title +
                      "</a>";
                  }
                  slicesOfContent.forEach(function(slice) {
                    resultItem += "<a href='" + articleUrl +
                      "'>" +
                      "<p class=\"search-result\">" +
                      highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });
                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML =
                '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML =
                '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function(resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft
                    .searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList =
                '<ul class=\"search-result-list\">';
              resultItems.forEach(function(result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }
          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function(event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }
          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');
          proceedsearch();
        }
      });
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function(event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

  </script>

  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    pbOptions = {};
    pbOptions.iconStyle = "default";
    pbOptions.boxForm = "horizontal";
    pbOptions.position = "bottomCenter";
    pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
    new needShareButton('#needsharebutton-postbottom', pbOptions);

  </script>

  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>

  <!-- calendar widget -->

  <script src="/lib/CloudCalendar/CloudCalendar.js"></script>
  <script src="/lib/CloudCalendar/languages.js"></script>
  <script type="text/javascript">
    $(function() {
      $('#CloudCalendar').aCalendar('zh-CN',
        $.extend(
          '', {
            single: true,
            root: '/calendar/'
          }
        )
      );
    });

  </script>

  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>

</body>

</html>
